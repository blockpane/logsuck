package guarddutylogs

import (
	"encoding/json"
	"fmt"
	"github.com/aws/aws-lambda-go/events"
	"testing"
)

// Just a random log entry ...
// a little incomplete only have examples for 3/4 types ...
var rawEvents = []string{
	`{"version":"0","id":"11223344-bbbb-cccc-dddd-ffffffffffff","detail-type":"GuardDuty Finding","source":"aws.guardduty","account":"112233445566","time":"2019-08-30T02:15:26Z","region":"us-east-1","resources":[],"detail":{"schemaVersion":"2.0","accountId":"112233445566","region":"us-east-1","partition":"aws","id":"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa","arn":"arn:aws:guardduty:us-east-1:112233445566:detector/11111111111111111111111111111111/finding/aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa","type":"Recon:EC2/PortProbeUnprotectedPort","resource":{"resourceType":"Instance","instanceDetails":{"instanceId":"i-bbbbbbbbbbbbbbbbb","instanceType":"t2.large","launchTime":"2018-12-19T17:18:27Z","platform":null,"productCodes":[{"productCodeId":"4444444444444444444444444","productCodeType":"marketplace"}],"iamInstanceProfile":null,"networkInterfaces":[{"ipv6Addresses":[],"networkInterfaceId":"eni-33333333333333333","privateDnsName":"ip-111-11-11-111.ec2.internal","privateIpAddress":"111.11.11.111","privateIpAddresses":[{"privateDnsName":"ip-222-22-22-222.ec2.internal","privateIpAddress":"111.11.11.111"}],"subnetId":"subnet-11111111","vpcId":"vpc-11111111","securityGroups":[{"groupName":"Ubuntu 18-04 LTS - Bionic-18-04 LTS 20180814-AutogenByAWSMP-","groupId":"sg-fffffffffffffffff"}],"publicDnsName":"ec2-18-210-240-10.compute-1.amazonaws.com","publicIp":"11.111.111.11"}],"tags":[{"key":"Name","value":"DEMO"}],"instanceState":"running","availabilityZone":"us-east-1b","imageId":"ami-fffffffffffffffff","imageDescription":"Canonical, Ubuntu, 18.04 LTS, amd64 bionic image build on 2018-08-14"}},"service":{"serviceName":"guardduty","detectorId":"11111111111111111111111111111111","action":{"actionType":"PORT_PROBE","portProbeAction":{"portProbeDetails":[{"localPortDetails":{"port":22,"portName":"SSH"},"remoteIpDetails":{"ipAddressV4":"22.22.222.22","organization":{"asn":"4134","asnOrg":"No.31,Jin-rong Street","isp":"China Telecom jiangsu","org":"China Telecom jiangsu"},"country":{"countryName":"China"},"city":{"cityName":"Wuhan"},"geoLocation":{"lat":30.5856,"lon":114.2665}}},{"localPortDetails":{"port":8889,"portName":"Unknown"},"remoteIpDetails":{"ipAddressV4":"11.22.222.111","organization":{"asn":"24961","asnOrg":"myLoc managed IT AG","isp":"myLoc managed IT AG","org":"myLoc managed IT AG"},"country":{"countryName":"Germany"},"city":{"cityName":"Bochum"},"geoLocation":{"lat":51.4925,"lon":7.3106}}}],"blocked":false}},"resourceRole":"TARGET","additionalInfo":{"threatName":"Scanner","threatListName":"ProofPoint"},"eventFirstSeen":"2019-07-31T02:17:08Z","eventLastSeen":"2019-08-30T02:05:40Z","archived":false,"count":1308},"severity":2,"createdAt":"2019-07-31T02:53:41.307Z","updatedAt":"2019-08-30T02:11:22.241Z","title":"Unprotected port on EC2 instance i-ccccccccccccccccc is being probed.","description":"EC2 instance has an unprotected port which is being probed by a known malicious host."}}`,
	`{"version":"0","id":"11223344-bbbb-cccc-dddd-ffffffffffff","detail-type":"GuardDuty Finding","source":"aws.guardduty","account":"112233445566","time":"2019-08-30T02:15:26Z","region":"us-east-1","resources":[],"detail":{"schemaVersion":"2.0","accountId":"112233445566","region":"us-east-1","partition":"aws","id":"bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb","arn":"arn:aws:guardduty:us-east-1:112233445566:detector/11111111111111111111111111111111/finding/bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb","type":"Policy:IAMUser/RootCredentialUsage","resource":{"resourceType":"AccessKey","accessKeyDetails":{"accessKeyId":"FFFFFFFFFFFFFFFFFFFF","principalId":"112233445566","userType":"Root","userName":"Root"}},"service":{"serviceName":"guardduty","detectorId":"22222222222222222222222222222222","action":{"actionType":"AWS_API_CALL","awsApiCallAction":{"api":"GetHostedZone","serviceName":"route53.amazonaws.com","callerType":"Remote IP","remoteIpDetails":{"ipAddressV4":"99.99.9.99","organization":{"asn":"7922","asnOrg":"Comcast Cable Communications, LLC","isp":"Comcast Cable","org":"Comcast Cable"},"country":{"countryName":"United States"},"city":{"cityName":"Parker"},"geoLocation":{"lat":39.4895,"lon":-104.8447}},"affectedResources":{}}},"resourceRole":"TARGET","additionalInfo":{},"evidence":null,"eventFirstSeen":"2019-08-12T16:09:58Z","eventLastSeen":"2019-08-16T17:38:40Z","archived":false,"count":143},"severity":2,"createdAt":"2019-08-12T16:20:54.374Z","updatedAt":"2019-08-16T17:51:34.544Z","title":"API GetHostedZone was invoked using root credentials.","description":"API GetHostedZone was invoked using root credentials from IP address 22.22.2.222."}}`,
	`{"version":"0","id":"11223344-bbbb-cccc-dddd-ffffffffffff","detail-type":"GuardDuty Finding","source":"aws.guardduty","account":"112233445566","time":"2019-08-30T02:15:26Z","region":"us-east-1","resources":[],"detail":{"schemaVersion":"2.0","accountId":"112233445566","region":"us-east-1","partition":"aws","id":"cccccccccccccccccccccccccccccccc","arn":"arn:aws:guardduty:us-east-1:112233445566:detector/11111111111111111111111111111111/finding/cccccccccccccccccccccccccccccccc","type":"UnauthorizedAccess:EC2/TorClient","resource":{"resourceType":"Instance","instanceDetails":{"instanceId":"i-aaaaaaaaaaaaaaaaa","instanceType":"t2.micro","launchTime":"2019-08-04T05:19:03Z","platform":null,"productCodes":[],"iamInstanceProfile":null,"networkInterfaces":[{"networkInterfaceId":"eni-fffffffffffffffff","privateIpAddresses":[{"privateDnsName":"ip-11-111-111-11.ec2.internal","privateIpAddress":"11.111.111.11"}],"subnetId":"subnet-fffffffffffffffff","vpcId":"vpc-aaaaaaaaaaaaaaaaa","privateDnsName":"ip-11-111-111-11.ec2.internal","securityGroups":[{"groupName":"vpn server","groupId":"sg-00000000000000000"}],"publicIp":"1.111.111.111","ipv6Addresses":[],"publicDnsName":"ec2-1-111-111-111.compute-1.amazonaws.com","privateIpAddress":"11.111.111.11"}],"tags":[{"value":"vpn","key":"Name"},{"value":"aaaaaaa","key":"project"}],"instanceState":"running","availabilityZone":"us-east-1a","imageId":"ami-aaaaaaaaaaaaaaaaa","imageDescription":"Canonical, Ubuntu, 18.04 LTS, amd64 bionic image build on 2019-07-22"}},"service":{"serviceName":"guardduty","detectorId":"cccccccccccccccccccccccccccccccc","action":{"actionType":"NETWORK_CONNECTION","networkConnectionAction":{"connectionDirection":"OUTBOUND","remoteIpDetails":{"ipAddressV4":"222.22.222.22","organization":{"asn":"24961","asnOrg":"myLoc managed IT AG","isp":"myLoc managed IT AG","org":"myLoc managed IT AG"},"country":{"countryName":"Germany"},"city":{"cityName":"Leverkusen"},"geoLocation":{"lat":51.0665,"lon":7.004}},"remotePortDetails":{"port":443,"portName":"HTTPS"},"localPortDetails":{"port":64342,"portName":"Unknown"},"protocol":"TCP","blocked":false}},"resourceRole":"TARGET","additionalInfo":{},"evidence":null,"eventFirstSeen":"2019-08-17T01:23:42Z","eventLastSeen":"2019-08-25T11:54:13Z","archived":false,"count":38},"severity":8,"createdAt":"2019-08-17T01:31:11.087Z","updatedAt":"2019-08-25T12:01:10.982Z","title":"EC2 instance i-ccccccccccccccccc is communicating with Tor Entry node.","description":"EC2 instance i-ccccccccccccccccc is communicating with IP address 222.22.222.22 on the Tor Anonymizing Proxy network marked as an Entry node."}}`,
}

func TestParseEvent(t *testing.T) {
	for _, rawEvent := range rawEvents {
		cwEvent := &events.CloudWatchEvent{}
		err := json.Unmarshal([]byte(rawEvent), cwEvent)
		if err != nil {
			t.Errorf("couldn't unmarshall raw event: %v\n", err)
		}
		gd, err := ParseEvent(&cwEvent.Detail)
		if err != nil {
			t.Errorf("couldn't decode Finding: %v\n", err)
		}
		logs, err := NewLogs(gd)
		if err != nil {
			t.Errorf("couldn't build logs slice: %v\n", err)
		}
		//fmt.Printf("%+v\n", logs)
		j, _ := json.MarshalIndent(logs, "", "  ")
		fmt.Println(string(j))
	}
}
